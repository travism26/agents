apiVersion: v1
kind: ServiceAccount
metadata:
  name: ci-cd-account
  namespace: agentic-email-writer

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: deployment-role
  namespace: agentic-email-writer
rules:
- apiGroups: ["", "apps", "autoscaling", "batch"]
  resources: ["deployments", "services", "pods", "configmaps", "secrets", "horizontalpodautoscalers"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ci-cd-role-binding
  namespace: agentic-email-writer
subjects:
- kind: ServiceAccount
  name: ci-cd-account
  namespace: agentic-email-writer
roleRef:
  kind: Role
  name: deployment-role
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: deployment-strategy
  namespace: agentic-email-writer
data:
  strategy.yaml: |
    blueGreen:
      activeService: agentic-email-writer
      previewService: agentic-email-writer-preview
      autoPromotionEnabled: false
      scaleDownDelaySeconds: 300
      previewReplicaCount: 1
      autoPromotionSeconds: 600
      antiAffinity: preferred
      maxUnavailable: 0

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rollback-config
  namespace: agentic-email-writer
data:
  rollback.yaml: |
    metrics:
      - name: http_error_rate
        threshold: 0.05
        window: 5m
    triggers:
      - type: metric
        name: http_error_rate
        threshold: 0.05
      - type: manual
        approvers:
          - team-lead
          - devops-engineer
    actions:
      - revert-deployment
      - notify-slack
      - create-incident

---
# Example GitHub Actions workflow file template
apiVersion: v1
kind: ConfigMap
metadata:
  name: github-workflow
  namespace: agentic-email-writer
data:
  deploy.yaml: |
    name: Deploy to Kubernetes
    on:
      push:
        branches: [ main ]
      pull_request:
        branches: [ main ]
    
    jobs:
      deploy:
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v3
        
        - name: Set up Node.js
          uses: actions/setup-node@v3
          with:
            node-version: '18'
            
        - name: Install dependencies
          run: npm ci
            
        - name: Run tests
          run: npm test
            
        - name: Build Docker image
          run: |
            docker build -t agentic-email-writer:${{ github.sha }} .
            
        - name: Configure kubectl
          uses: azure/k8s-set-context@v1
          with:
            kubeconfig: ${{ secrets.KUBE_CONFIG }}
            
        - name: Deploy to staging
          run: |
            kubectl apply -f k8s/namespace.yaml
            kubectl apply -f k8s/mongodb.yaml
            kubectl apply -f k8s/redis.yaml
            kubectl apply -f k8s/app.yaml
            kubectl apply -f k8s/monitoring.yaml
            
        - name: Run integration tests
          run: npm run test:integration
            
        - name: Deploy to production
          if: github.ref == 'refs/heads/main'
          run: |
            kubectl set image deployment/agentic-email-writer \
              agentic-email-writer=agentic-email-writer:${{ github.sha }}
            
        - name: Monitor deployment
          run: |
            kubectl rollout status deployment/agentic-email-writer -n agentic-email-writer
            
        - name: Notify on failure
          if: failure()
          run: |
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"Deployment failed!"}' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
